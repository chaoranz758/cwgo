path: main.go
update_behavior:
  type: skip
body: |-
  package main

  import (
    "github.com/cloudwego/kitex/pkg/klog"
    {{- if eq .Codec "thrift"}}
    "github.com/cloudwego/kitex/pkg/transmeta"
    {{- end }}
    "github.com/cloudwego/kitex/server"
    kitexlogrus "github.com/kitex-contrib/obs-opentelemetry/logging/logrus"
    "{{.Module}}/conf"
    "{{.ImportPath}}/{{ToLower .ServiceName}}"
    "gopkg.in/natefinch/lumberjack.v2"
  )

  func main() {
    opts := kitexInit()

    svr := {{ToLower .ServiceName}}.NewServer(new({{.ServiceName}}Impl), opts...)

    err := svr.Run()
    if err != nil {
      klog.Error(err.Error())
    }
  }

  func kitexInit() (opts []server.Option) {
    {{- if eq .Codec "thrift"}}
     // thrift meta handler
     opts = append(opts, server.WithMetaHandler(transmeta.ServerTTHeaderHandler))
    {{- end}}

    // klog
    logger := kitexlogrus.NewLogger()
    klog.SetLogger(logger)
    klog.SetLevel(conf.LogLevel())
    klog.SetOutput(&lumberjack.Logger{
          		Filename:   conf.GetConf().Log.LogFileName,
          		MaxSize:    conf.GetConf().Log.LogMaxSize,
          		MaxBackups: conf.GetConf().Log.LogMaxBackups,
          		MaxAge:     conf.GetConf().Log.LogMaxAge,
          	})
    return
  }
